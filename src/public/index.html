<!DOCTYPE html>
<html lang="pt-BR">
    <head>
        <meta charset="utf-8">
        <title>TransferData | Compartilhe Arquivos entre Dispositivos</title>
        <meta name="description" content="Compartilhe arquivos entre dispositivos de maneira fácil e rápida com o TransferData.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#FAFAFA">
        <link rel="icon" type="image/x-icon" href="favicon.ico">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha512-NhSC1YmyruXifcj/KFRWoC561YpHpc5Jtzgvbuzx5VozKpWvQ+4nXhPdFgmx8xqexRcpAglTj9sIBWINXa8x5w==" 
              crossorigin="anonymous" referrerpolicy="no-referrer" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <link rel="stylesheet" href="styles/styles.css">
        <script src="/socket.io/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>
    <body>
        <header>
            <div class="header__brand">
                <i class="bi bi-file-earmark-arrow-up"></i>
                <a href="#">Transfer<span>Data</span></a>
            </div>
        </header>
        <main>
            <div class="content1 form">
                <div class="form__room">
                    <div class="input-group">
                        <input id="room" class="form-control" type="text" 
                               placeholder="Crie ou insira o nome de uma sala..." 
                               aria-label="Crie ou insira o nome de uma sala..." 
                               aria-describedby="join-btn"
                        >
                        <button id="join-btn" class="button-primary" type="button">
                            <span>Entrar</span>
                            <i class="bi bi-box-arrow-in-right"></i>
                        </button>
                    </div>
                </div>
                <div class="form__files">
                    <div class="form__files-dragdrop form-group files">
                        <label for="image">
                            <span class="label-text-xl">Importe seu arquivo</span>
                            <i class="label-text bi bi-folder2-open"></i>
                            <span class="label-text">Arraste e importe uma <b>Imagem</b>, <b>PDF</b> ou <b>Vídeo*</b>,</span>
                            <span class="label-text">ou escolha um no seu dispositivo.</span>
                        </label>
                        <input id="image" class="form-control" type="file" name="image"> 
                    </div>
                    <span class="form__files-notes">Formatos suportados: png, jpg, pdf, mp4.</span>
                    <div class="input-group">
                        <textarea id='contentInput'></textarea>
                    </div>
                    <button id="apply-btn" class="button-primary">
                        <span>Enviar</span>
                        <i class="bi bi-send"></i>
                    </button>
                </div>
            </div>
            <div class="content2 display">
                <div id="imageDiv"></div>
                <div id="text"></div>
            </div>
        </main>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
        <script type="module">
            import useApi from "./scripts/api.js";
            import createListener from "./scripts/createEventListener.js"
            import getElementById from "./scripts/getElement.js";
            import handleJoinRoom from "./scripts/handleJoin.js";
            import handleChange from "./scripts/handleChange.js";
            import handleApplyContent from "./scripts/handleApply.js";
            import createUser from "./scripts/createUser.js";

            let api;
            const socket = io();

            const text = getElementById(document,"text");
            const imageDiv = getElementById(document,"imageDiv");
            const roomInput = getElementById(document,"room");
            const contentInput = getElementById(document,"contentInput");
            const joinButton = getElementById(document,"join-btn");
            const applyButton = getElementById(document,"apply-btn");
            const imageInput = getElementById(document,"image");
            const user = createUser();

            const handleJoin = (event) => handleJoinRoom(event, socket, roomInput, user, imageDiv, text);
            const handleApply = (event) => handleApplyContent(event, socket, contentInput, user);
            const handleImageChange = (event) => {
                if(!user.room) return imageInput.value = null;
                handleChange(event, api.uploadImage, emitImage);
            }
         
            createListener(joinButton,"click", handleJoin);
            createListener(applyButton,"click", handleApply);
            

            function setImage(filename){
                console.log(filename)
                imageDiv.innerHTML = '';
                imageInput.value = null;
                if(!filename) return;

                let image;
                const extension = filename.slice(filename.length-3);
                
                if(extension === 'pdf' || extension === "mp4" ){
                    image = document.createElement("iframe");
                }else{
                    image = document.createElement("img");
                }
                image.width = 300;
                image.height = 300;
                image.src = api.baseURL+'files/'+ filename;

                imageDiv.appendChild(image);

            }

            function emitImage(filename){
                const data = {
                    room:user.room,
                    filename
                }
                socket.emit("imageUpload", data);
            }

            socket.on("setup", (baseURL)=>{
                api = useApi(axios, baseURL);
                createListener(imageInput ,"change", handleImageChange);
            })

            socket.on('message', (roomData)=>{
                text.innerText = roomData.text;
                setImage(roomData.image);
            })

        </script>
    </body>
</html>
